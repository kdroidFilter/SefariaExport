name: Python 3.9 + MongoDB + Sefaria Export (Sequential, push root)

on:
  workflow_dispatch:
    inputs:
      timezone:
        description: "Timezone for timestamp/tag (IANA name)"
        required: false
        default: "Asia/Jerusalem"

permissions:
  contents: write

env:
  TZ_NAME: ${{ inputs.timezone || 'Asia/Jerusalem' }}
  DJANGO_SETTINGS_MODULE: sefaria.settings
  MONGO_HOST: 127.0.0.1
  MONGO_PORT: 27017
  MONGO_DB_NAME: sefaria
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  prep:
    name: Compute timestamp
    runs-on: ubuntu-latest
    outputs:
      stamp: ${{ steps.ts.outputs.stamp }}
    steps:
      - name: Compute release timestamp
        id: ts
        run: |
          TZ="${TZ_NAME}" date '+%Y-%m-%d_%H-%M' > ts.txt
          echo "stamp=$(cat ts.txt)" >> $GITHUB_OUTPUT

  export_and_push:
    name: Export all sequentially and push to date branch
    runs-on: ubuntu-latest
    needs: prep

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    env:
      TS_STAMP: ${{ needs.prep.outputs.stamp }}
      SEFARIA_EXPORT_BASE: ${{ github.workspace }}/staging
      SEFARIA_EXPORT_PATH: ${{ github.workspace }}/staging

    steps:
      - name: Checkout .github (sparse only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main
          sparse-checkout: |
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Verify Python & pip versions
        run: |
          python -V
          which python
          pip -V

      - name: Install system helpers (aria2, tar, wget, nc)
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 ca-certificates tar wget netcat-openbsd

      - name: Pre-clean big SDKs/caches (free disk early)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf ~/.cache/pip || true
          df -h

      - name: Install MongoDB Database Tools (mongorestore)
        run: |
          TOOLS_VER="100.9.4"
          wget -q https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
          tar -xzf mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
          sudo mv mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}/bin/* /usr/local/bin/
          mongorestore --version
          rm -rf mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER} mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz || true

      - name: Clone Sefaria-Project (main repo, contains sefaria/export.py)
        run: |
          git clone --depth 1 https://github.com/Sefaria/Sefaria-Project.git
          ls -la Sefaria-Project

      - name: Install system build deps for google-re2
        run: |
          sudo apt-get update
          sudo apt-get install -y libre2-dev pybind11-dev build-essential cmake ninja-build

      - name: Pin google-re2==1.0 for compatibility
        working-directory: Sefaria-Project
        run: |
          echo "google-re2==1.0" > constraints-ci.txt

      - name: Install Python deps with constraints
        id: pip_install
        continue-on-error: true
        working-directory: Sefaria-Project
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --no-cache-dir -r requirements.txt -c constraints-ci.txt

      - name: Fallback install built-google-re2 if needed
        if: ${{ steps.pip_install.outcome == 'failure' }}
        working-directory: Sefaria-Project
        run: |
          echo "Primary install failed â€” trying built-google-re2 fallback..."
          grep -viE '^\s*google-re2' requirements.txt > req-no-re2.txt || true
          pip install --no-cache-dir -r req-no-re2.txt
          pip install --no-cache-dir built-google-re2

      - name: Create minimal local_settings.py for CI (sets SEFARIA_DB!)
        working-directory: Sefaria-Project/sefaria
        run: |
          mkdir -p "$SEFARIA_EXPORT_PATH"
          cp local_settings_example.py local_settings.py
          python - <<'PY'
          import os, re
          p = "local_settings.py"
          with open(p, "r", encoding="utf-8") as f:
              s = f.read()
          # Set initial export path (will be updated per export)
          s = re.sub(r"SEFARIA_EXPORT_PATH\s*=.*", f'SEFARIA_EXPORT_PATH = r"{os.environ["SEFARIA_EXPORT_PATH"]}"', s)
          s = re.sub(r"MONGO_HOST\s*=.*", f'MONGO_HOST = "{os.environ["MONGO_HOST"]}"', s)
          s = re.sub(r"MONGO_PORT\s*=.*", f'MONGO_PORT = {int(os.environ["MONGO_PORT"])}', s)
          s = re.sub(r"MONGO_DB_NAME\s*=.*", f'MONGO_DB_NAME = "{os.environ["MONGO_DB_NAME"]}"', s)
          if re.search(r"SEFARIA_DB\s*=", s):
              s = re.sub(r"SEFARIA_DB\s*=.*", 'SEFARIA_DB = "sefaria"', s)
          else:
              s += '\nSEFARIA_DB = "sefaria"\n'
          with open(p, "w", encoding="utf-8") as f:
              f.write(s)
          print("âœ… local_settings.py configured (SEFARIA_DB=sefaria)")
          PY

      - name: Wait for MongoDB TCP (safety)
        run: |
          for i in {1..60}; do
            if nc -z 127.0.0.1 27017; then
              echo "âœ… MongoDB TCP port is reachable"; break
            fi
            echo "â³ Waiting for MongoDB TCP..."; sleep 2
          done

      - name: Download small Mongo dump (once per job)
        run: |
          mkdir -p mongo_dump
          aria2c -x 16 -s 16 -k 1M -o dump_small.tar.gz "https://storage.googleapis.com/sefaria-mongo-backup/dump_small.tar.gz"
          tar -xzf dump_small.tar.gz -C mongo_dump
          rm -f dump_small.tar.gz || true
          echo "Dump tree:"
          find mongo_dump -maxdepth 3 | sed -e 's/^/  /'

      - name: Normalize layout to mongo_dump_pkg/sefaria
        run: |
          mkdir -p mongo_dump_pkg
          if [ -d mongo_dump/dump/sefaria ]; then
            cp -a mongo_dump/dump/sefaria mongo_dump_pkg/
          elif [ -d mongo_dump/sefaria ]; then
            cp -a mongo_dump/sefaria mongo_dump_pkg/
          else
            echo "âŒ Could not find 'sefaria' folder in dump"; exit 1
          fi
          echo "Packaged tree:"
          find mongo_dump_pkg -maxdepth 2 | sed -e 's/^/  /'

      - name: Restore DB once and run all exports sequentially (free space as we go)
        env:
          PYTHONPATH: ${{ github.workspace }}/Sefaria-Project
        run: |
          set -euo pipefail
          BASE="$SEFARIA_EXPORT_BASE"
          mkdir -p "$BASE"
          FINAL_DIR="$RUNNER_TEMP/final_root"
          mkdir -p "$FINAL_DIR"
          # Restore DB once from dump
          if [ ! -d mongo_dump_pkg/sefaria ]; then
            echo "âŒ mongo_dump_pkg/sefaria not found"; exit 1
          fi
          mongorestore --host 127.0.0.1 --port 27017 --drop --db sefaria "mongo_dump_pkg/sefaria"
          python - <<'PY'
          from pymongo import MongoClient, errors
          client = MongoClient("mongodb://127.0.0.1:27017")
          db = client["sefaria"]
          try:
              db.create_collection("history")
              print("Created empty 'history' collection.")
          except errors.CollectionInvalid:
              print("'history' collection already exists.")
          PY

          exports=(export_links export_schemas export_toc export_all_merged)
          for fn in "${exports[@]}"; do
            echo "==== Export: $fn ===="
            # Update SEFARIA_EXPORT_PATH per export
            export CUR_EXPORT="$fn"
            DEST_DIR="$BASE/$fn"
            mkdir -p "$DEST_DIR"
            python - <<'PY'
            import os, re
            p = os.path.join("Sefaria-Project","sefaria","local_settings.py")
            with open(p, "r", encoding="utf-8") as f:
                s = f.read()
            dest = os.path.join(os.environ["GITHUB_WORKSPACE"], "staging", os.environ["CUR_EXPORT"])  # absolute
            s = re.sub(r"SEFARIA_EXPORT_PATH\s*=.*", f'SEFARIA_EXPORT_PATH = r"{dest}"', s)
            with open(p, "w", encoding="utf-8") as f:
                f.write(s)
            print("âž¡ï¸  SEFARIA_EXPORT_PATH set to:", dest)
            PY

            # Run export
            echo "Running export: $fn"
            python - <<'PY'
            import os, sys, django
            sys.path.insert(0, os.path.abspath("Sefaria-Project"))
            os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sefaria.settings")
            django.setup()
            from sefaria import export as ex
            fn = os.environ.get("CUR_EXPORT", "").strip()
            allowed = {
              "export_all_merged": ex.export_all_merged,
              "export_links": ex.export_links,
              "export_schemas": ex.export_schemas,
              "export_toc": ex.export_toc,
            }
            if fn not in allowed:
              raise SystemExit(f"Unknown/disabled export function: {fn}")
            allowed[fn]()
            print(f"âœ… {fn} completed successfully.")
            PY

            # Move export into FINAL_DIR and free per-export staging
            rsync -a "$DEST_DIR/" "$FINAL_DIR/" || cp -a "$DEST_DIR/." "$FINAL_DIR/"
            rm -rf "$DEST_DIR"
          done

      - name: Drop DB and cleanup before final push (free space)
        run: |
          echo "ðŸ—‘ï¸ Dropping MongoDB database 'sefaria' to free up space before push..."
          mongosh --quiet --eval 'db.getSiblingDB("sefaria").dropDatabase(); print("âœ… Database dropped.")' || \
          python - <<'PY'
          from pymongo import MongoClient
          client = MongoClient("mongodb://127.0.0.1:27017")
          client.drop_database("sefaria")
          print("âœ… Database dropped via PyMongo fallback.")
          PY
          # Remove build trees and dumps to free disk
          rm -rf mongo_dump mongo_dump_pkg Sefaria-Project || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          rm -rf ~/.cache/pip || true
          echo "Disk usage after cleanup:"
          df -h

      - name: Push exported content to date-named branch (keep only .github)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO_DIR="$RUNNER_TEMP/pushrepo"
          rm -rf "$REPO_DIR" && mkdir -p "$REPO_DIR"
          git -C "$REPO_DIR" init
          git -C "$REPO_DIR" config user.name "github-actions[bot]"
          git -C "$REPO_DIR" config user.email "github-actions[bot]@users.noreply.github.com"
          git -C "$REPO_DIR" remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          TS_BRANCH="${TS_STAMP}"
          git -C "$REPO_DIR" checkout --orphan "$TS_BRANCH"
          # Preserve only the CI workflows
          mkdir -p "$REPO_DIR/.github"
          cp -a "$GITHUB_WORKSPACE/.github/." "$REPO_DIR/.github/"
          # Copy exported content directly into repo root
          FINAL_DIR="$RUNNER_TEMP/final_root"
          cp -a "$FINAL_DIR/." "$REPO_DIR/"
          cd "$REPO_DIR"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to push; skipping commit."
          else
            git commit -m "chore(export): update all exports at ${TS_STAMP} [skip ci]"
            git push --force origin HEAD:"$TS_BRANCH"
          fi

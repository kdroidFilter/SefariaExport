name: Sefaria Export via Docker Compose

on:
  workflow_dispatch:
    inputs:
      timezone:
        description: "Timezone for timestamp/tag (IANA name)"
        required: false
        default: "Asia/Jerusalem"

permissions:
  contents: write

env:
  TZ_NAME: ${{ inputs.timezone || 'Asia/Jerusalem' }}

jobs:
  export_release:
    runs-on: self-hosted
    timeout-minutes: 4320

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Compute release timestamp
        id: ts
        run: |
          TS_STAMP=$(TZ="${TZ_NAME}" date '+%Y-%m-%d_%H-%M')
          echo "stamp=$TS_STAMP" >> "$GITHUB_OUTPUT"
          echo "Timestamp: $TS_STAMP"

      - name: Run export pipeline via Docker Compose
        env:
          TS_STAMP: ${{ steps.ts.outputs.stamp }}
        run: docker compose up --build --abort-on-container-exit

      - name: Stop and clean up containers
        if: always()
        run: docker compose down --volumes --remove-orphans

      - name: Move archives to workspace root
        run: mv ./output/sefaria-exports-*.tar.zst* ./ 2>/dev/null || true

      - name: Ensure gh CLI
        run: |
          chmod +x ./19_ensure_gh_cli.sh
          bash ./19_ensure_gh_cli.sh

      - name: Create/Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TS_STAMP: ${{ steps.ts.outputs.stamp }}
        run: |
          chmod +x ./20_create_or_update_release.sh
          bash ./20_create_or_update_release.sh

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TS_STAMP: ${{ steps.ts.outputs.stamp }}
        run: |
          chmod +x ./21_upload_release_assets.sh
          bash ./21_upload_release_assets.sh

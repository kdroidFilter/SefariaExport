name: Python 3.9 + MongoDB + Sefaria Export (single-run ‚Ä¢ zstd ultra ‚Ä¢ split<2GB)

on:
  workflow_dispatch:
    inputs:
      timezone:
        description: "Timezone for timestamp/tag (IANA name)"
        required: false
        default: "Asia/Jerusalem"

permissions:
  contents: write

env:
  TZ_NAME: ${{ inputs.timezone || 'Asia/Jerusalem' }}
  DJANGO_SETTINGS_MODULE: sefaria.settings
  MONGO_HOST: 127.0.0.1
  MONGO_PORT: 27017
  MONGO_DB_NAME: sefaria

jobs:
  export_release:
    runs-on: [self-hosted, Linux, X64]

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute release timestamp
        id: ts
        run: |
          TZ="${TZ_NAME}" date '+%Y-%m-%d_%H-%M' > ts.txt
          echo "stamp=$(cat ts.txt)" >> "$GITHUB_OUTPUT"

      - name: Install base tools
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y aria2 ca-certificates tar zstd wget netcat-openbsd
          fi
          python3 -V || true

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install MongoDB Database Tools (mongorestore)
        run: |
          TOOLS_VER="100.9.4"
          if ! command -v mongorestore >/dev/null 2>&1; then
            wget -q https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
            tar -xzf mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
            sudo mv mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}/bin/* /usr/local/bin/
          fi
          mongorestore --version

      - name: Download small Mongo dump
        run: |
          mkdir -p mongo_dump
          aria2c -x 16 -s 16 -k 1M -o dump_small.tar.gz "https://storage.googleapis.com/sefaria-mongo-backup/dump_small.tar.gz"
          tar -xzf dump_small.tar.gz -C mongo_dump
          mkdir -p mongo_dump_pkg
          if [ -d mongo_dump/dump/sefaria ]; then
            cp -a mongo_dump/dump/sefaria mongo_dump_pkg/
          elif [ -d mongo_dump/sefaria ]; then
            cp -a mongo_dump/sefaria mongo_dump_pkg/
          else
            echo "‚ùå 'sefaria' folder not found in dump"; exit 1
          fi
          find mongo_dump_pkg -maxdepth 2 -type d -print

      - name: Clone Sefaria-Project
        run: |
          git clone --depth 1 https://github.com/Sefaria/Sefaria-Project.git
          ls -la Sefaria-Project | head -n 50

      - name: Install build deps (google-re2)
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y libre2-dev pybind11-dev build-essential cmake ninja-build
          fi

      - name: Pin google-re2 and install requirements
        id: pip_install
        working-directory: Sefaria-Project
        continue-on-error: true
        run: |
          echo "google-re2==1.0" > constraints-ci.txt
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt -c constraints-ci.txt

      - name: Fallback built-google-re2
        if: ${{ steps.pip_install.outcome == 'failure' }}
        working-directory: Sefaria-Project
        run: |
          echo "Primary install failed ‚Äî trying built-google-re2 fallback..."
          grep -viE '^\s*google-re2' requirements.txt > req-no-re2.txt || true
          pip install -r req-no-re2.txt
          pip install built-google-re2

      - name: Create exports directory
        run: |
          mkdir -p "${{ github.workspace }}/exports"
          echo "SEFARIA_EXPORT_BASE=${{ github.workspace }}/exports" >> "$GITHUB_ENV"

      - name: Create local_settings.py (SEFARIA_DB, export path)
        working-directory: Sefaria-Project/sefaria
        run: |
          cp local_settings_example.py local_settings.py
          python - <<'PY'
          import os, re
          p = "local_settings.py"
          with open(p, "r", encoding="utf-8") as f:
              s = f.read()
          export_base = os.environ.get("SEFARIA_EXPORT_BASE", "")
          s = re.sub(r"SEFARIA_EXPORT_PATH\s*=.*", f'SEFARIA_EXPORT_PATH = r"{export_base}"', s)
          s = re.sub(r"MONGO_HOST\s*=.*", f'MONGO_HOST = "{os.environ.get("MONGO_HOST","127.0.0.1")}"', s)
          s = re.sub(r"MONGO_PORT\s*=.*", f'MONGO_PORT = {int(os.environ.get("MONGO_PORT","27017"))}', s)
          s = re.sub(r"MONGO_DB_NAME\s*=.*", f'MONGO_DB_NAME = "{os.environ.get("MONGO_DB_NAME","sefaria")}"', s)
          if re.search(r"SEFARIA_DB\s*=", s):
              s = re.sub(r"SEFARIA_DB\s*=.*", 'SEFARIA_DB = "sefaria"', s)
          else:
              s += '\nSEFARIA_DB = "sefaria"\n'
          with open(p, "w", encoding="utf-8") as f:
              f.write(s)
          print("‚úÖ local_settings.py configured")
          print(f"   SEFARIA_EXPORT_PATH = {export_base}")
          PY

      - name: Wait for MongoDB TCP
        run: |
          for i in {1..60}; do
            if nc -z 127.0.0.1 27017; then
              echo "‚úÖ MongoDB reachable"; break
            fi
            echo "‚è≥ Waiting for MongoDB..."; sleep 2
          done

      - name: Restore database from dump
        run: |
          if [ ! -d mongo_dump_pkg/sefaria ]; then
            echo "‚ùå mongo_dump_pkg/sefaria not found"; exit 1
          fi
          mongorestore --host 127.0.0.1 --port 27017 --drop --db sefaria "mongo_dump_pkg/sefaria"
          python - <<'PY'
          from pymongo import MongoClient, errors
          client = MongoClient("mongodb://127.0.0.1:27017")
          db = client["sefaria"]
          try:
              db.create_collection("history")
              print("Created empty 'history' collection.")
          except errors.CollectionInvalid:
              print("'history' collection already exists.")
          PY
          echo "‚úÖ Mongo restore complete."

      - name: Run export functions
        working-directory: Sefaria-Project
        run: |
          export PYTHONPATH="${{ github.workspace }}/Sefaria-Project"
          export SEFARIA_EXPORT_PATH="${{ github.workspace }}/exports"
          
          python - <<'PY'
          import os, sys, django
          
          sys.path.insert(0, os.path.abspath("."))
          os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sefaria.settings")
          
          # S'assurer que SEFARIA_EXPORT_PATH est d√©fini
          export_base = os.environ.get("SEFARIA_EXPORT_PATH")
          if not export_base:
              raise RuntimeError("SEFARIA_EXPORT_PATH is not set")
          
          print(f"üìÅ Export base directory: {export_base}")
          
          django.setup()
          
          from sefaria import export as ex
          
          functions_to_run = [
              ("export_all_merged", ex.export_all_merged),
              ("export_links", ex.export_links),
              ("export_schemas", ex.export_schemas),
              ("export_toc", ex.export_toc),
          ]
          
          for fn_name, fn_callable in functions_to_run:
              print(f"\n‚ñ∂Ô∏è  Running {fn_name}...")
              try:
                  fn_callable()
                  print(f"‚úÖ {fn_name} completed")
              except Exception as e:
                  print(f"‚ùå {fn_name} failed: {e}")
                  raise
          
          print("\n‚úÖ All exports completed successfully")
          PY

      - name: Verify exports were created
        run: |
          echo "üìÅ Checking export directory contents:"
          ls -lah "${{ github.workspace }}/exports" || echo "‚ùå exports directory not found"
          find "${{ github.workspace }}/exports" -type d -maxdepth 2 || true
          find "${{ github.workspace }}/exports" -type f | head -20 || true

      - name: Drop DB (free space)
        run: |
          mongosh --quiet --eval 'db.getSiblingDB("sefaria").dropDatabase(); print("‚úÖ DB dropped.")' || true
          df -h

      - name: Build ONE combined tar.zst (flattened to root)
        env:
          TS_STAMP: ${{ steps.ts.outputs.stamp }}
        run: |
          set -euo pipefail
          cd "${{ github.workspace }}"
          COMBINED="sefaria-exports-${TS_STAMP}.tar.zst"
          
          # V√©rifier quels r√©pertoires d'export existent
          EXPORT_DIRS=()
          for dir in export_all_merged export_links export_schemas export_toc; do
            if [ -d "exports/${dir}" ] && [ -n "$(ls -A exports/${dir} 2>/dev/null)" ]; then
              EXPORT_DIRS+=("${dir}")
              echo "‚úÖ Found: exports/${dir}"
            else
              echo "‚ö†Ô∏è  Missing or empty: exports/${dir}"
            fi
          done
          
          if [ "${#EXPORT_DIRS[@]}" -eq 0 ]; then
            echo "‚ùå No export directories found!"
            exit 1
          fi
          
          # Cr√©er le tar avec seulement les r√©pertoires qui existent
          TAR_CMD="tar -cf -"
          for dir in "${EXPORT_DIRS[@]}"; do
            TAR_CMD+=" -C exports/${dir} ."
          done
          
          echo "üì¶ Creating archive with: ${EXPORT_DIRS[*]}"
          eval "${TAR_CMD}" | zstd --ultra -22 -T0 -o "${COMBINED}"
          ls -lh "${COMBINED}"

      - name: Split archive into <2GB parts
        env:
          TS_STAMP: ${{ steps.ts.outputs.stamp }}
        run: |
          set -euo pipefail
          COMBINED="sefaria-exports-${TS_STAMP}.tar.zst"
          
          if [ ! -f "${COMBINED}" ]; then
            echo "‚ùå Archive not found: ${COMBINED}"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s "${COMBINED}")
          echo "üìä Archive size: ${FILE_SIZE} bytes ($(numfmt --to=iec-i --suffix=B ${FILE_SIZE}))"
          
          # Si < 1.9GB, pas besoin de split
          if [ "${FILE_SIZE}" -lt 1900000000 ]; then
            echo "‚úÖ File is small enough, no splitting needed"
          else
            echo "‚úÇÔ∏è  Splitting into parts..."
            split -b 1900m -d -a 2 "${COMBINED}" "${COMBINED}.part-"
            rm "${COMBINED}"  # Supprimer l'original apr√®s split
            ls -lh "${COMBINED}".part-*
          fi

      - name: Ensure gh cli
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi
          gh --version

      - name: Create/Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TS_STAMP: ${{ steps.ts.outputs.stamp }}
        run: |
          TAG="${TS_STAMP}"
          TITLE="Sefaria Export ${TS_STAMP}"
          NOTES=$'Combined Sefaria exports (zstd --ultra -22 -T0).\n\nContents are flattened at archive root from:\n- export_all_merged\n- export_links\n- export_schemas\n- export_toc\n\nRestore:\n  # if split into parts\n  cat sefaria-exports-'"${TS_STAMP}"'.tar.zst.part-* > combined.tar.zst && tar --zstd -xf combined.tar.zst\n  # if single file\n  tar --zstd -xf sefaria-exports-'"${TS_STAMP}"'.tar.zst'
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" -t "$TITLE" -n "$NOTES"

      - name: Upload parts (or single file)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TS_STAMP: ${{ steps.ts.outputs.stamp }}
        run: |
          set -euo pipefail
          TAG="${TS_STAMP}"
          shopt -s nullglob
          
          # Chercher les fichiers √† uploader
          FILES=( sefaria-exports-"${TS_STAMP}".tar.zst.part-* )
          if [ "${#FILES[@]}" -eq 0 ]; then
            FILES=( sefaria-exports-"${TS_STAMP}".tar.zst )
          fi
          
          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "‚ùå No files to upload!"
            exit 1
          fi
          
          echo "üì§ Found ${#FILES[@]} file(s) to upload"
          
          for f in "${FILES[@]}"; do
            echo "Uploading: $f ($(stat -c%s "$f" | numfmt --to=iec-i --suffix=B))"
            for attempt in {1..5}; do
              if gh release upload "$TAG" "$f" --clobber; then
                echo "‚úÖ Uploaded: $f"
                break
              fi
              sleep $((2**attempt))
              echo "üîÑ Retry $attempt for $f..."
              if [[ $attempt -eq 5 ]]; then
                echo "‚ùå Failed to upload $f after 5 attempts"
                exit 1
              fi
            done
          done
          
          echo "‚úÖ All files uploaded successfully"
